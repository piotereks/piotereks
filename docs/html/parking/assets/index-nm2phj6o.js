import{r as pe,g as ie,a as p,R as Y,L as Z,E as he}from"./vendor-echarts-nZu8rBDa.js";import{r as ge}from"./vendor-react-BVyvVbwp.js";import{r as fe}from"./vendor-utils-F0zOxUcV.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const h of c.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&i(h)}).observe(document,{childList:!0,subtree:!0});function o(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function i(r){if(r.ep)return;r.ep=!0;const c=o(r);fetch(r.href,c)}})();var J={exports:{}},V={};var Q;function ye(){if(Q)return V;Q=1;var e=pe(),a=Symbol.for("react.element"),o=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,r=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function h(C,f,S){var g,w={},I=null,u=null;S!==void 0&&(I=""+S),f.key!==void 0&&(I=""+f.key),f.ref!==void 0&&(u=f.ref);for(g in f)i.call(f,g)&&!c.hasOwnProperty(g)&&(w[g]=f[g]);if(C&&C.defaultProps)for(g in f=C.defaultProps,f)w[g]===void 0&&(w[g]=f[g]);return{$$typeof:a,type:C,key:I,ref:u,props:w,_owner:r.current}}return V.Fragment=o,V.jsx=h,V.jsxs=h,V}var X;function xe(){return X||(X=1,J.exports=ye()),J.exports}var t=xe(),K={},ee;function be(){if(ee)return K;ee=1;var e=ge();return K.createRoot=e.createRoot,K.hydrateRoot=e.hydrateRoot,K}var Se=be();const Ne=ie(Se),le=p.createContext(),ve=({children:e})=>{const[a,o]=p.useState(localStorage.getItem("parking_theme")==="light");p.useEffect(()=>{a?(document.body.classList.remove("dark"),localStorage.setItem("parking_theme","light")):(document.body.classList.add("dark"),localStorage.setItem("parking_theme","dark"))},[a]);const i=()=>o(!a);return t.jsx(le.Provider,{value:{isLight:a,toggleTheme:i},children:e})},ce=()=>p.useContext(le);var we=fe();const je=ie(we),de=p.createContext(),Te=["https://gd.zaparkuj.pl/api/freegroupcountervalue.json","https://gd.zaparkuj.pl/api/freegroupcountervalue-green.json"],Ee="https://corsproxy.io/?",Ce="https://docs.google.com/spreadsheets/d/e/2PACX-1vTwLNDbg8KjlVHsZWj9JUnO_OBIyZaRgZ4gZ8_Gbyly2J3f6rlCW6lDHAihwbuLhxWbBkNMI1wdWRAq/pub?gid=411529798&single=true&output=csv",Re="https://docs.google.com/forms/d/e/1FAIpQLSdeQ-rmw_VfOidGmtSNb9DLkt1RfPdduu-jH898sf3lhj17LA/formResponse",W={GREENDAY_VALUE:"entry.2026993163",GREENDAY_TIME:"entry.51469670",UNI_VALUE:"entry.1412144904",UNI_TIME:"entry.364658642"},te="parking_realtime_cache",B="parking_history_cache",D={GD_TIME:"gd_time",GD_VALUE:"greenday free",UNI_TIME:"uni_time",UNI_VALUE:"uni free"},ae=e=>e?e.trim().toLowerCase():"",Le=(e,a)=>{if(!e)return null;const o=ae(a);return Object.keys(e).find(i=>ae(i)===o)||null},z=(e,a)=>{const o=Le(e,a);if(!o)return;const i=e[o];return typeof i=="string"?i.trim():i},_e=e=>{if(!e)return null;const a=e.includes("T")?e:e.replace(" ","T"),o=new Date(a);return Number.isNaN(o.getTime())?null:o},se=(e,a,o)=>{if(!e)return null;const i=z(e,a),r=_e(i);if(!r)return null;const c=z(e,o),h=c==null||c===""?null:Number(c);return{raw:i,date:r,value:Number.isNaN(h)?null:h}},De=e=>{if(!e||e.length===0)return{gd:null,uni:null};const a=e[e.length-1];return{gd:se(a,D.GD_TIME,D.GD_VALUE),uni:se(a,D.UNI_TIME,D.UNI_VALUE)}},ne=(e=[])=>{const a=new Set,o=[];return e.forEach(i=>{const r=z(i,D.GD_TIME)||"",c=z(i,D.UNI_TIME)||"",h=`${r}|||${c}`;a.has(h)||(a.add(h),o.push(i))}),o},re=e=>{if(!e||!e.Timestamp)return null;const a=e.Timestamp.trim();if(!a)return null;const o=a.includes("T")?a:a.replace(" ","T"),i=new Date(o);if(Number.isNaN(i.getTime()))return null;const r=Number(e.CurrentFreeGroupCounterValue);return{raw:a,date:i,value:Number.isNaN(r)?null:r}},Ie=(e=[])=>Array.isArray(e)?e.map(a=>({...a||{}})):[],ke=(e,a)=>({[D.GD_TIME]:e?.Timestamp||"",[D.GD_VALUE]:e?.CurrentFreeGroupCounterValue??"",[D.UNI_TIME]:a?.Timestamp||"",[D.UNI_VALUE]:a?.CurrentFreeGroupCounterValue??""}),oe=()=>{if(typeof localStorage>"u")return{rows:[],timestamp:null,last:{gd:null,uni:null}};const e=localStorage.getItem(B);if(!e)return{rows:[],timestamp:null,last:{gd:null,uni:null}};try{const a=JSON.parse(e),o=Array.isArray(a.data)?a.data:[];return{rows:o,timestamp:a.timestamp||null,last:De(o)}}catch(a){return console.error("Failed to parse history cache snapshot:",a),{rows:[],timestamp:null,last:{gd:null,uni:null}}}},Ae=({children:e})=>{const[a,o]=p.useState([]),[i,r]=p.useState(!0),[c,h]=p.useState(null),[C,f]=p.useState(null),[S,g]=p.useState([]),[w,I]=p.useState(!1),[u,A]=p.useState(null),R=p.useRef(!1),U=p.useCallback(m=>{const d=Array.isArray(m)?m:[],y=new Date;g(d),A(y);try{localStorage.setItem(B,JSON.stringify({data:d,timestamp:y.toISOString()})),console.log("History cache updated")}catch(s){console.error("Failed to cache history data:",s)}},[]),G=p.useCallback(async m=>{try{const d=m[0],y=m[1];if(!d||!y){console.log("Missing data for form submission");return}const s=d.CurrentFreeGroupCounterValue||0,L=d.Timestamp||"",x=y.CurrentFreeGroupCounterValue||0,k=y.Timestamp||"",_=new URLSearchParams;_.append(W.GREENDAY_VALUE,s.toString()),_.append(W.GREENDAY_TIME,L),_.append(W.UNI_VALUE,x.toString()),_.append(W.UNI_TIME,k),console.log("Submitting to Google Form:",{greenDay:{value:s,time:L},uni:{value:x,time:k}});const n=await fetch(Re,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:_.toString(),mode:"no-cors"});console.log("Form submission completed")}catch(d){console.error("Failed to submit to Google Form:",d)}},[]),M=p.useCallback(async()=>{I(!0);try{const d=await(await fetch(`${Ce}&time=${Date.now()}`,{cache:"no-store",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}})).text();je.parse(d,{header:!0,skipEmptyLines:!0,complete:y=>{const s=ne(y.data||[]);console.log("CSV fetched, parsed, and deduplicated"),U(s),I(!1)}})}catch(m){console.error("Failed to fetch history data:",m),I(!1)}},[U]),N=p.useCallback(async()=>{if(R.current){console.log("Fetch already in progress, skipping...");return}R.current=!0,r(!0),h(null);try{const m=localStorage.getItem(te);if(m)try{const s=JSON.parse(m);o(s.data),f(new Date(s.timestamp)),console.log("Real-time cache loaded")}catch(s){console.error("Failed to parse real-time cache:",s)}const d=await Promise.all(Te.map(s=>fetch(`${Ee}${encodeURIComponent(s+"?time="+Date.now())}`).then(L=>L.ok?L.json():Promise.reject(`HTTP ${L.status}`))));o(d);const y=new Date;f(y);try{localStorage.setItem(te,JSON.stringify({data:d,timestamp:y.toISOString()}))}catch(s){console.error("Failed to cache real-time data:",s)}await j(d)}catch(m){console.error("Failed to fetch real-time data:",m),h(m.toString())}finally{r(!1),R.current=!1}},[]),j=p.useCallback(async m=>{try{const d=re(m[0]),y=re(m[1]);console.log("API timestamps:",{gd:d?.date?.toISOString(),uni:y?.date?.toISOString()});let s=oe();s.rows.length&&S.length===0&&(g(s.rows),s.timestamp&&A(new Date(s.timestamp)));const L=!d?.date||s.last.gd?.date&&d.date.getTime()<=s.last.gd.date.getTime(),x=!y?.date||s.last.uni?.date&&y.date.getTime()<=s.last.uni.date.getTime();if(s.rows.length>0&&L&&x){console.log("Fast path hit â€” cache already covers API timestamps");return}console.log("Slow path triggered â€” fetching CSV for reconciliation"),await M(),s=oe(),s.rows.length&&(g(s.rows),s.timestamp&&A(new Date(s.timestamp)));const _=d?.date?!s.last.gd?.date||d.date.getTime()>s.last.gd.date.getTime():!1,n=y?.date?!s.last.uni?.date||y.date.getTime()>s.last.uni.date.getTime():!1;if(!_&&!n){console.log("After reconciliation, no newer timestamps detected");return}const l=Ie(m);for(;l.length<2;)l.push({});if(s.last.gd?.date){const v=d?.date;(!v||v.getTime()<s.last.gd.date.getTime())&&(l[0]={...l[0],Timestamp:s.last.gd.raw,CurrentFreeGroupCounterValue:s.last.gd.value??l[0].CurrentFreeGroupCounterValue??0})}if(s.last.uni?.date){const v=y?.date;(!v||v.getTime()<s.last.uni.date.getTime())&&(l[1]={...l[1],Timestamp:s.last.uni.raw,CurrentFreeGroupCounterValue:s.last.uni.value??l[1].CurrentFreeGroupCounterValue??0})}await G(l);const b=ne([...s.rows,ke(l[0],l[1])]);U(b)}catch(d){console.error("Error checking history update:",d)}},[M,S.length,U,G]);p.useEffect(()=>{const m=localStorage.getItem(B);if(m)try{const d=JSON.parse(m);g(d.data),A(new Date(d.timestamp)),console.log("History cache loaded on mount")}catch(d){console.error("Failed to load history cache on mount:",d)}},[]),p.useEffect(()=>{N();const m=setInterval(N,300*1e3);return()=>clearInterval(m)},[N]);const H=p.useCallback(async()=>{console.log("Manual refresh triggered"),await N()},[N]),$={realtimeData:a,realtimeLoading:i,realtimeError:c,lastRealtimeUpdate:C,historyData:S,historyLoading:w,lastHistoryUpdate:u,refresh:H};return t.jsx(de.Provider,{value:$,children:e})},ue=()=>{const e=p.useContext(de);if(!e)throw new Error("useParkingData must be used within ParkingDataProvider");return e},me=({title:e,shortTitle:a,icon:o,onRefresh:i,updateStatus:r,currentView:c,setView:h,children:C})=>{const{isLight:f,toggleTheme:S}=ce();return t.jsxs("header",{className:"header-controls",children:[t.jsxs("div",{className:"header-title-group",children:[t.jsxs("h1",{children:[t.jsx("span",{className:"title-icon",children:o}),t.jsxs("span",{className:"title-text-full",children:[" ",e]}),t.jsxs("span",{className:"title-text-short",children:[" ",a||e]})]}),t.jsx("div",{className:"status-info",children:r})]}),t.jsxs("div",{className:"header-actions",children:[C,i&&t.jsxs("button",{className:"nav-btn",onClick:i,children:[t.jsx("span",{className:"btn-icon",children:"âŸ³"}),t.jsx("span",{className:"btn-text",children:"Refresh"})]}),c==="stats"&&t.jsxs("button",{className:"nav-btn",onClick:()=>h("dashboard"),children:[t.jsx("span",{className:"btn-icon",children:"ðŸ "}),t.jsx("span",{className:"btn-text",children:"Dashboard"})]}),c==="dashboard"&&t.jsxs("button",{className:"nav-btn",onClick:()=>h("stats"),children:[t.jsx("span",{className:"btn-icon",children:"ðŸ“Š"}),t.jsx("span",{className:"btn-text",children:"Statistics"})]}),t.jsx("button",{className:"theme-toggle",onClick:S,"aria-label":"Toggle theme",children:f?"ðŸŒ™":"â˜€ï¸"})]})]})},Ue=({data:e,now:a})=>{const o=new Date(e.Timestamp.replace(" ","T")),i=Math.max(0,Math.floor((a-o)/1e3/60));let r="";i>=15?r="age-old":i>5&&(r="age-medium");let c=e.ParkingGroupName;return c==="Bank_1"&&(c="Uni Wroc"),t.jsxs("div",{className:"parking-card",children:[t.jsx("div",{className:"parking-name",children:c}),t.jsx("div",{className:`free-spots ${r}`,children:e.CurrentFreeGroupCounterValue||0}),t.jsxs("div",{className:"age-indicator-small",children:[i," min ago"]}),t.jsxs("div",{className:"timestamp-small",children:["@",o.toLocaleTimeString("pl-PL")]})]})},Pe=({setView:e})=>{const{realtimeData:a,realtimeLoading:o,realtimeError:i,lastRealtimeUpdate:r,refresh:c}=ue(),[h,C]=p.useState(new Date);p.useEffect(()=>{const g=setInterval(()=>C(new Date),1e3);return()=>clearInterval(g)},[]);const f=a.reduce((g,w)=>g+(w.CurrentFreeGroupCounterValue||0),0),S=r?`Last update: ${r.toLocaleTimeString("pl-PL")}`:"Loading...";return t.jsxs(t.Fragment,{children:[t.jsx(me,{title:"Parking Monitor",icon:"ðŸ…¿ï¸",onRefresh:c,updateStatus:S,currentView:"dashboard",setView:e}),t.jsxs("main",{className:"container-main",children:[t.jsx("div",{className:"subtitle",children:"Real-time parking availability â€¢ UBS WrocÅ‚aw"}),i&&t.jsxs("div",{className:"error",children:[t.jsx("strong",{children:"ERROR:"})," ",i]}),t.jsx("div",{className:"grid-container",children:o&&a.length===0?t.jsx("div",{className:"loader",children:"Loading parking data..."}):a.map((g,w)=>t.jsx(Ue,{data:g,now:h},w))}),t.jsxs("div",{className:"status-panel",children:[t.jsxs("div",{className:"panel-section",children:[t.jsx("div",{className:"status-label",children:"Total Spaces"}),t.jsx("div",{className:"status-value big-value",children:o?"---":f})]}),t.jsxs("div",{className:"panel-section",children:[t.jsx("div",{className:"status-label",children:"Data Status"}),t.jsx("div",{className:"status-value",style:{color:i?"var(--warning)":"var(--success)"},children:o?"LOADING":i?"OFFLINE":"ONLINE"})]}),t.jsxs("div",{className:"panel-section",children:[t.jsx("div",{className:"status-label",children:"Last Update / Current Time"}),t.jsxs("div",{className:"time-group",children:[t.jsx("span",{children:r?r.toLocaleTimeString("pl-PL"):"--:--:--"}),t.jsx("span",{className:"status-current-inline",children:h.toLocaleTimeString("pl-PL")})]})]})]})]})]})},q={neon:{gd:"#05ffa1",uni:"#01beff"},classic:{gd:"#3b82f6",uni:"#f59e0b"},cyberpunk:{gd:"#00d9ff",uni:"#ff00cc"},modern:{gd:"#10b981",uni:"#6366f1"}},Fe=({setView:e})=>{const{historyData:a,historyLoading:o,refresh:i}=ue(),[r,c]=Y.useState("neon"),[h,C]=Y.useState(!1),{isLight:f}=ce(),S=p.useRef({start:0,end:100}),g=p.useRef(null),w=p.useMemo(()=>{if(!a||a.length===0)return null;const u=f?"#1e293b":"#8b95c9",A=f?"#cbd5e1":"#2d3b6b",R=window.innerWidth<=600,U=new Map,G=new Map;a.forEach(n=>{const l=F=>Object.keys(n).find(T=>T.trim().toLowerCase()===F),b=l("gd_time"),v=l("greenday free"),O=l("uni_time"),P=l("uni free");if(b&&v&&n[b]&&n[v]){const F=n[b].trim(),T=parseFloat(n[v]);isNaN(T)||U.set(F,T)}if(O&&P&&n[O]&&n[P]){const F=n[O].trim(),T=parseFloat(n[P]);isNaN(T)||G.set(F,T)}});const M=n=>Array.from(n.entries()).map(([l,b])=>({t:new Date(l),v:b,raw:l})).filter(l=>!isNaN(l.t.getTime())).sort((l,b)=>l.t-b.t);let N=M(U),j=M(G);const H=n=>{const l=new Set;return n.filter(b=>{const v=`${b.raw}|${b.v}`;return l.has(v)?!1:(l.add(v),!0)})};if(N=H(N),j=H(j),N.length>0&&j.length>0){const n=N[0].t.getTime(),l=j[0].t.getTime();l<n&&(j[0].t=new Date(n),j[0].raw=N[0].raw),n<l&&(N[0].t=new Date(l),N[0].raw=j[0].raw)}const $=[...N.map(n=>n.t.getTime()),...j.map(n=>n.t.getTime())],m=$.length>0?Math.max(...$):null;let d=null;if(m){const n=N.find(b=>b.t.getTime()===m),l=j.find(b=>b.t.getTime()===m);d=(n||l)?.raw}const y=(n,l,b)=>{if(n.length===0)return{solid:[],gaps:[],projections:[]};const v=[],O=[],P=[],F=2400*1e3;for(let E=0;E<n.length;E++)v.push([n[E].raw,n[E].v]),E<n.length-1&&n[E+1].t-n[E].t>F&&(v.push([n[E+1].raw,null]),O.push([n[E].raw,n[E].v],[n[E+1].raw,n[E+1].v],[n[E+1].raw,null]));const T=n[n.length-1];return T&&l&&l-T.t.getTime()>1e3&&(P.push([T.raw,T.v]),P.push([b,T.v])),{solid:v,gaps:O,projections:P}},s=y(N,m,d),L=y(j,m,d),x=q[r],k=N.length>0?"GreenDay":"GreenDay - not found",_=j.length>0?"Uni Wroc":"Uni Wroc - not found";return{backgroundColor:"transparent",animation:!0,animationDuration:300,tooltip:{trigger:"axis",confine:!0,axisPointer:{type:"cross"}},legend:{data:[k,_],top:5,textStyle:{color:u}},grid:{left:R?10:15,right:R?10:15,bottom:R?80:50,top:40,containLabel:!0},xAxis:{type:"time",axisLabel:{color:u,margin:10},axisLine:{lineStyle:{color:A}},splitLine:{show:!1}},yAxis:{type:"value",min:-5,max:200,splitLine:{lineStyle:{color:A,opacity:.3}},axisLabel:{color:u,formatter:n=>n<0?"":n}},dataZoom:[{type:"inside",start:S.current.start,end:S.current.end,filterMode:"none"},{type:"slider",start:S.current.start,end:S.current.end,bottom:R?40:10,height:R?30:25,textStyle:{color:u,fontSize:R?11:12},filterMode:"none",handleSize:R?"180%":"100%",borderColor:u,fillerColor:"rgba(100, 149, 237, 0.3)",dataBackground:{lineStyle:{color:u,opacity:.5},areaStyle:{color:u,opacity:.2}},moveHandleSize:R?10:7,emphasis:{handleStyle:{borderWidth:2}}}],series:[{name:k,type:"line",data:s.solid,showSymbol:h,lineStyle:{width:3,color:x.gd},itemStyle:{color:x.gd},areaStyle:{color:new Z(0,0,0,1,[{offset:0,color:`${x.gd}33`},{offset:1,color:`${x.gd}00`}])},markLine:{symbol:"none",data:[{yAxis:187,lineStyle:{color:x.gd,type:"dotted",opacity:1},label:{position:"start",formatter:"187",color:x.gd,fontWeight:"bold",fontSize:13}}]}},{name:k,type:"line",data:s.gaps,showSymbol:!1,lineStyle:{width:2,color:x.gd,type:"dashed",opacity:.4},tooltip:{show:!1}},{name:k,type:"line",data:s.projections,showSymbol:!1,lineStyle:{width:1.5,color:x.gd,type:[5,5],opacity:.5},tooltip:{show:!1}},{name:_,type:"line",data:L.solid,showSymbol:h,lineStyle:{width:3,color:x.uni},itemStyle:{color:x.uni},areaStyle:{color:new Z(0,0,0,1,[{offset:0,color:`${x.uni}33`},{offset:1,color:`${x.uni}00`}])},markLine:{symbol:"none",data:[{yAxis:41,lineStyle:{color:x.uni,type:"dotted",opacity:1},label:{position:"start",formatter:"41",color:x.uni,fontWeight:"bold",fontSize:13}}]}},{name:_,type:"line",data:L.gaps,showSymbol:!1,lineStyle:{width:2,color:x.uni,type:"dashed",opacity:.4},tooltip:{show:!1}},{name:_,type:"line",data:L.projections,showSymbol:!1,lineStyle:{width:1.5,color:x.uni,type:[5,5],opacity:.5},tooltip:{show:!1}}]}},[a,r,h,f]),I={datazoom:u=>{u.batch&&u.batch[0]?S.current={start:u.batch[0].start,end:u.batch[0].end}:u.start!==void 0&&u.end!==void 0&&(S.current={start:u.start,end:u.end})}};return t.jsxs("div",{className:"page-wrapper",children:[t.jsx(me,{title:"Parking History",shortTitle:"Hist",icon:"ðŸ“ˆ",onRefresh:i,updateStatus:o?"Updating...":"Ready",currentView:"stats",setView:e,children:t.jsxs("div",{className:"palette-group",children:[t.jsx("span",{className:"palette-label",children:"Palette:"}),Object.keys(q).map(u=>t.jsx("div",{className:`palette-btn ${r===u?"active":""}`,style:{background:`linear-gradient(135deg, ${q[u].gd} 50%, ${q[u].uni} 50%)`},onClick:()=>c(u),title:u.charAt(0).toUpperCase()+u.slice(1)},u)),t.jsxs("button",{className:"palette-toggle-btn",onClick:()=>C(!h),children:["Dots: ",h?"Off":"On"]})]})}),t.jsx("main",{className:"stats-container",children:o&&a.length===0?t.jsx("div",{className:"loader",children:"Loading history data..."}):w?t.jsx(he,{ref:g,option:w,style:{height:"100%",width:"100%",touchAction:"none"},onEvents:I,notMerge:!1,lazyUpdate:!0,opts:{renderer:"canvas"}}):t.jsx("div",{className:"loader",children:"No data available to display."})})]})};function Oe(){const[e,a]=p.useState("dashboard");return t.jsx(ve,{children:t.jsx(Ae,{children:e==="dashboard"?t.jsx(Pe,{setView:a}):t.jsx(Fe,{setView:a})})})}Ne.createRoot(document.getElementById("root")).render(t.jsx(Y.StrictMode,{children:t.jsx(Oe,{})}));
