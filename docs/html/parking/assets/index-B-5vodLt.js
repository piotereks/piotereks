import{r as ne,g as X,a as c,R as K,L as z,E as re}from"./vendor-echarts-nZu8rBDa.js";import{r as ie}from"./vendor-react-BVyvVbwp.js";import{r as le}from"./vendor-utils-F0zOxUcV.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))p(a);new MutationObserver(a=>{for(const d of a)if(d.type==="childList")for(const h of d.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&p(h)}).observe(document,{childList:!0,subtree:!0});function x(a){const d={};return a.integrity&&(d.integrity=a.integrity),a.referrerPolicy&&(d.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?d.credentials="include":a.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function p(a){if(a.ep)return;a.ep=!0;const d=x(a);fetch(a.href,d)}})();var q={exports:{}},G={};var Y;function ce(){if(Y)return G;Y=1;var u=ne(),n=Symbol.for("react.element"),x=Symbol.for("react.fragment"),p=Object.prototype.hasOwnProperty,a=u.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,d={key:!0,ref:!0,__self:!0,__source:!0};function h(T,g,v){var f,j={},C=null,r=null;v!==void 0&&(C=""+v),g.key!==void 0&&(C=""+g.key),g.ref!==void 0&&(r=g.ref);for(f in g)p.call(g,f)&&!d.hasOwnProperty(f)&&(j[f]=g[f]);if(T&&T.defaultProps)for(f in g=T.defaultProps,g)j[f]===void 0&&(j[f]=g[f]);return{$$typeof:n,type:T,key:C,ref:r,props:j,_owner:a.current}}return G.Fragment=x,G.jsx=h,G.jsxs=h,G}var B;function de(){return B||(B=1,q.exports=ce()),q.exports}var e=de(),$={},Z;function me(){if(Z)return $;Z=1;var u=ie();return $.createRoot=u.createRoot,$.hydrateRoot=u.hydrateRoot,$}var ue=me();const pe=X(ue),ee=c.createContext(),he=({children:u})=>{const[n,x]=c.useState(localStorage.getItem("parking_theme")==="light");c.useEffect(()=>{n?(document.body.classList.remove("dark"),localStorage.setItem("parking_theme","light")):(document.body.classList.add("dark"),localStorage.setItem("parking_theme","dark"))},[n]);const p=()=>x(!n);return e.jsx(ee.Provider,{value:{isLight:n,toggleTheme:p},children:u})},te=()=>c.useContext(ee);var ge=le();const fe=X(ge),se=c.createContext(),ye=["https://gd.zaparkuj.pl/api/freegroupcountervalue.json","https://gd.zaparkuj.pl/api/freegroupcountervalue-green.json"],xe="https://corsproxy.io/?",Se="https://docs.google.com/spreadsheets/d/e/2PACX-1vTwLNDbg8KjlVHsZWj9JUnO_OBIyZaRgZ4gZ8_Gbyly2J3f6rlCW6lDHAihwbuLhxWbBkNMI1wdWRAq/pub?gid=411529798&single=true&output=csv",be="https://docs.google.com/forms/d/e/1FAIpQLSdeQ-rmw_VfOidGmtSNb9DLkt1RfPdduu-jH898sf3lhj17LA/formResponse",V={GREENDAY_VALUE:"entry.2026993163",GREENDAY_TIME:"entry.51469670",UNI_VALUE:"entry.1412144904",UNI_TIME:"entry.364658642"},Q="parking_realtime_cache",J="parking_history_cache",Ne=({children:u})=>{const[n,x]=c.useState([]),[p,a]=c.useState(!0),[d,h]=c.useState(null),[T,g]=c.useState(null),[v,f]=c.useState([]),[j,C]=c.useState(!1),[r,O]=c.useState(null),R=c.useRef(!1),A=c.useCallback(async o=>{try{const i=o[0],y=o[1];if(!i||!y){console.log("Missing data for form submission");return}const m=i.CurrentFreeGroupCounterValue||0,s=i.Timestamp||"",l=y.CurrentFreeGroupCounterValue||0,S=y.Timestamp||"",t=new URLSearchParams;t.append(V.GREENDAY_VALUE,m.toString()),t.append(V.GREENDAY_TIME,s),t.append(V.UNI_VALUE,l.toString()),t.append(V.UNI_TIME,S),console.log("Submitting to Google Form:",{greenDay:{value:m,time:s},uni:{value:l,time:S}});const b=await fetch(be,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString(),mode:"no-cors"});console.log("Form submission completed")}catch(i){console.error("Failed to submit to Google Form:",i)}},[]),M=c.useCallback(o=>{if(!o||o.length===0)return{gd:null,uni:null};const i=(s,l)=>Object.keys(s).find(S=>S.trim().toLowerCase()===l);let y=null,m=null;for(let s=o.length-1;s>=0;s--){const l=o[s];if(!y){const S=i(l,"gd_time");if(S&&l[S]){const t=new Date(l[S].trim());isNaN(t.getTime())||(y=t)}}if(!m){const S=i(l,"uni_time");if(S&&l[S]){const t=new Date(l[S].trim());isNaN(t.getTime())||(m=t)}}if(y&&m)break}return{gd:y,uni:m}},[]),D=c.useCallback(async()=>{if(R.current){console.log("Fetch already in progress, skipping...");return}R.current=!0,a(!0),h(null);try{const o=localStorage.getItem(Q);if(o)try{const m=JSON.parse(o);x(m.data),g(new Date(m.timestamp)),console.log("Real-time cache loaded")}catch(m){console.error("Failed to parse real-time cache:",m)}const i=await Promise.all(ye.map(m=>fetch(`${xe}${encodeURIComponent(m+"?time="+Date.now())}`).then(s=>s.ok?s.json():Promise.reject(`HTTP ${s.status}`))));x(i);const y=new Date;g(y);try{localStorage.setItem(Q,JSON.stringify({data:i,timestamp:y.toISOString()}))}catch(m){console.error("Failed to cache real-time data:",m)}await P(i)}catch(o){console.error("Failed to fetch real-time data:",o),h(o.toString())}finally{a(!1),R.current=!1}},[]),P=c.useCallback(async o=>{try{const i=o[0]?.Timestamp?new Date(o[0].Timestamp.replace(" ","T")):null,y=o[1]?.Timestamp?new Date(o[1].Timestamp.replace(" ","T")):null;console.log("API timestamps:",{gd:i?.toISOString(),uni:y?.toISOString()});const m=localStorage.getItem(J);let s=null,l={gd:null,uni:null};if(m)try{const N=JSON.parse(m);s=N.data,l=M(s),console.log("History cache timestamps:",{gd:l.gd?.toISOString(),uni:l.uni?.toISOString()}),v.length===0&&(f(s),O(new Date(N.timestamp)))}catch(N){console.error("Failed to parse history cache:",N)}const S=i&&l.gd&&i.getTime()>l.gd.getTime(),t=y&&l.uni&&y.getTime()>l.uni.getTime(),b=!l.gd&&!l.uni;b||S||t?(console.log("New data detected:",{noCache:b,gdNewer:S,uniNewer:t}),await A(o),console.log("Fetching CSV..."),await U()):console.log("History cache is up to date")}catch(i){console.error("Error checking history update:",i)}},[v.length,M,A]),U=c.useCallback(async()=>{C(!0);try{const i=await(await fetch(`${Se}&time=${Date.now()}`)).text();fe.parse(i,{header:!0,skipEmptyLines:!0,complete:y=>{const m=y.data;console.log("CSV fetched and parsed"),f(m);const s=new Date;O(s);try{localStorage.setItem(J,JSON.stringify({data:m,timestamp:s.toISOString()})),console.log("History cache updated")}catch(l){console.error("Failed to cache history data:",l)}C(!1)}})}catch(o){console.error("Failed to fetch history data:",o),C(!1)}},[]);c.useEffect(()=>{const o=localStorage.getItem(J);if(o)try{const i=JSON.parse(o);f(i.data),O(new Date(i.timestamp)),console.log("History cache loaded on mount")}catch(i){console.error("Failed to load history cache on mount:",i)}},[]),c.useEffect(()=>{D();const o=setInterval(D,300*1e3);return()=>clearInterval(o)},[D]);const H=c.useCallback(async()=>{console.log("Manual refresh triggered"),await D()},[D]),E={realtimeData:n,realtimeLoading:p,realtimeError:d,lastRealtimeUpdate:T,historyData:v,historyLoading:j,lastHistoryUpdate:r,refresh:H};return e.jsx(se.Provider,{value:E,children:u})},ae=()=>{const u=c.useContext(se);if(!u)throw new Error("useParkingData must be used within ParkingDataProvider");return u},oe=({title:u,shortTitle:n,icon:x,onRefresh:p,updateStatus:a,currentView:d,setView:h,children:T})=>{const{isLight:g,toggleTheme:v}=te();return e.jsxs("header",{className:"header-controls",children:[e.jsxs("div",{className:"header-title-group",children:[e.jsxs("h1",{children:[e.jsx("span",{className:"title-icon",children:x}),e.jsxs("span",{className:"title-text-full",children:[" ",u]}),e.jsxs("span",{className:"title-text-short",children:[" ",n||u]})]}),e.jsx("div",{className:"status-info",children:a})]}),e.jsxs("div",{className:"header-actions",children:[T,p&&e.jsxs("button",{className:"nav-btn",onClick:p,children:[e.jsx("span",{className:"btn-icon",children:"âŸ³"}),e.jsx("span",{className:"btn-text",children:"Refresh"})]}),d==="stats"&&e.jsxs("button",{className:"nav-btn",onClick:()=>h("dashboard"),children:[e.jsx("span",{className:"btn-icon",children:"ðŸ "}),e.jsx("span",{className:"btn-text",children:"Dashboard"})]}),d==="dashboard"&&e.jsxs("button",{className:"nav-btn",onClick:()=>h("stats"),children:[e.jsx("span",{className:"btn-icon",children:"ðŸ“Š"}),e.jsx("span",{className:"btn-text",children:"Statistics"})]}),e.jsx("button",{className:"theme-toggle",onClick:v,"aria-label":"Toggle theme",children:g?"ðŸŒ™":"â˜€ï¸"})]})]})},ve=({data:u,now:n})=>{const x=new Date(u.Timestamp.replace(" ","T")),p=Math.max(0,Math.floor((n-x)/1e3/60));let a="";p>=15?a="age-old":p>5&&(a="age-medium");let d=u.ParkingGroupName;return d==="Bank_1"&&(d="Uni Wroc"),e.jsxs("div",{className:"parking-card",children:[e.jsx("div",{className:"parking-name",children:d}),e.jsx("div",{className:`free-spots ${a}`,children:u.CurrentFreeGroupCounterValue||0}),e.jsxs("div",{className:"age-indicator-small",children:[p," min ago"]}),e.jsxs("div",{className:"timestamp-small",children:["@",x.toLocaleTimeString("pl-PL")]})]})},je=({setView:u})=>{const{realtimeData:n,realtimeLoading:x,realtimeError:p,lastRealtimeUpdate:a,refresh:d}=ae(),[h,T]=c.useState(new Date);c.useEffect(()=>{const f=setInterval(()=>T(new Date),1e3);return()=>clearInterval(f)},[]);const g=n.reduce((f,j)=>f+(j.CurrentFreeGroupCounterValue||0),0),v=a?`Last update: ${a.toLocaleTimeString("pl-PL")}`:"Loading...";return e.jsxs(e.Fragment,{children:[e.jsx(oe,{title:"Parking Monitor",icon:"ðŸ…¿ï¸",onRefresh:d,updateStatus:v,currentView:"dashboard",setView:u}),e.jsxs("main",{className:"container-main",children:[e.jsx("div",{className:"subtitle",children:"Real-time parking availability â€¢ UBS WrocÅ‚aw"}),p&&e.jsxs("div",{className:"error",children:[e.jsx("strong",{children:"ERROR:"})," ",p]}),e.jsx("div",{className:"grid-container",children:x&&n.length===0?e.jsx("div",{className:"loader",children:"Loading parking data..."}):n.map((f,j)=>e.jsx(ve,{data:f,now:h},j))}),e.jsxs("div",{className:"status-panel",children:[e.jsxs("div",{className:"panel-section",children:[e.jsx("div",{className:"status-label",children:"Total Spaces"}),e.jsx("div",{className:"status-value big-value",children:x?"---":g})]}),e.jsxs("div",{className:"panel-section",children:[e.jsx("div",{className:"status-label",children:"Data Status"}),e.jsx("div",{className:"status-value",style:{color:p?"var(--warning)":"var(--success)"},children:x?"LOADING":p?"OFFLINE":"ONLINE"})]}),e.jsxs("div",{className:"panel-section",children:[e.jsx("div",{className:"status-label",children:"Last Update / Current Time"}),e.jsxs("div",{className:"time-group",children:[e.jsx("span",{children:a?a.toLocaleTimeString("pl-PL"):"--:--:--"}),e.jsx("span",{className:"status-current-inline",children:h.toLocaleTimeString("pl-PL")})]})]})]})]})]})},W={neon:{gd:"#05ffa1",uni:"#01beff"},classic:{gd:"#3b82f6",uni:"#f59e0b"},cyberpunk:{gd:"#00d9ff",uni:"#ff00cc"},modern:{gd:"#10b981",uni:"#6366f1"}},we=({setView:u})=>{const{historyData:n,historyLoading:x,refresh:p}=ae(),[a,d]=K.useState("neon"),[h,T]=K.useState(!1),{isLight:g}=te(),v=c.useRef({start:80,end:100}),f=c.useRef(null),j=c.useMemo(()=>{if(!n||n.length===0)return null;const r=g?"#1e293b":"#8b95c9",O=g?"#cbd5e1":"#2d3b6b",R=window.innerWidth<=600,A=new Map,M=new Map;n.forEach(t=>{const b=I=>Object.keys(t).find(w=>w.trim().toLowerCase()===I),N=b("gd_time"),_=b("greenday free"),F=b("uni_time"),k=b("uni free");if(N&&_&&t[N]&&t[_]){const I=t[N].trim(),w=parseFloat(t[_]);isNaN(w)||A.set(I,w)}if(F&&k&&t[F]&&t[k]){const I=t[F].trim(),w=parseFloat(t[k]);isNaN(w)||M.set(I,w)}});const D=t=>Array.from(t.entries()).map(([b,N])=>({t:new Date(b),v:N,raw:b})).filter(b=>!isNaN(b.t.getTime())).sort((b,N)=>b.t-N.t),P=D(A),U=D(M),H=[...P.map(t=>t.t.getTime()),...U.map(t=>t.t.getTime())],E=H.length>0?Math.max(...H):null;let o=null;if(E){const t=P.find(N=>N.t.getTime()===E),b=U.find(N=>N.t.getTime()===E);o=(t||b)?.raw}const i=(t,b,N)=>{if(t.length===0)return{solid:[],gaps:[],projections:[]};const _=[],F=[],k=[],I=2400*1e3;for(let L=0;L<t.length;L++)_.push([t[L].raw,t[L].v]),L<t.length-1&&t[L+1].t-t[L].t>I&&(_.push([t[L+1].raw,null]),F.push([t[L].raw,t[L].v],[t[L+1].raw,t[L+1].v],[t[L+1].raw,null]));const w=t[t.length-1];return w&&b&&b-w.t.getTime()>1e3&&(k.push([w.raw,w.v]),k.push([N,w.v])),{solid:_,gaps:F,projections:k}},y=i(P,E,o),m=i(U,E,o),s=W[a],l=P.length>0?"GreenDay":"GreenDay - not found",S=U.length>0?"Uni Wroc":"Uni Wroc - not found";return{backgroundColor:"transparent",animation:!0,tooltip:{trigger:"axis",confine:!0,axisPointer:{type:"cross"}},legend:{data:[l,S],top:5,textStyle:{color:r}},grid:{left:R?10:15,right:R?10:15,bottom:R?80:50,top:40,containLabel:!0},xAxis:{type:"time",axisLabel:{color:r,margin:10},axisLine:{lineStyle:{color:O}},splitLine:{show:!1}},yAxis:{type:"value",min:-5,max:200,splitLine:{lineStyle:{color:O,opacity:.3}},axisLabel:{color:r,formatter:t=>t<0?"":t}},dataZoom:[{type:"inside",start:v.current.start,end:v.current.end,filterMode:"none"},{type:"slider",start:v.current.start,end:v.current.end,bottom:R?40:10,height:R?30:25,textStyle:{color:r,fontSize:R?11:12},filterMode:"none",handleSize:R?"180%":"100%",borderColor:r,fillerColor:"rgba(100, 149, 237, 0.3)",dataBackground:{lineStyle:{color:r,opacity:.5},areaStyle:{color:r,opacity:.2}},moveHandleSize:R?10:7,emphasis:{handleStyle:{borderWidth:2}}}],series:[{name:l,type:"line",data:y.solid,showSymbol:h,lineStyle:{width:3,color:s.gd},itemStyle:{color:s.gd},areaStyle:{color:new z(0,0,0,1,[{offset:0,color:`${s.gd}33`},{offset:1,color:`${s.gd}00`}])},markLine:{symbol:"none",data:[{yAxis:187,lineStyle:{color:s.gd,type:"dotted",opacity:1},label:{position:"start",formatter:"187",color:s.gd,fontWeight:"bold",fontSize:13}}]}},{name:l,type:"line",data:y.gaps,showSymbol:!1,lineStyle:{width:2,color:s.gd,type:"dashed",opacity:.4},tooltip:{show:!1}},{name:l,type:"line",data:y.projections,showSymbol:!1,lineStyle:{width:1.5,color:s.gd,type:[5,5],opacity:.5},tooltip:{show:!1}},{name:S,type:"line",data:m.solid,showSymbol:h,lineStyle:{width:3,color:s.uni},itemStyle:{color:s.uni},areaStyle:{color:new z(0,0,0,1,[{offset:0,color:`${s.uni}33`},{offset:1,color:`${s.uni}00`}])},markLine:{symbol:"none",data:[{yAxis:41,lineStyle:{color:s.uni,type:"dotted",opacity:1},label:{position:"start",formatter:"41",color:s.uni,fontWeight:"bold",fontSize:13}}]}},{name:S,type:"line",data:m.gaps,showSymbol:!1,lineStyle:{width:2,color:s.uni,type:"dashed",opacity:.4},tooltip:{show:!1}},{name:S,type:"line",data:m.projections,showSymbol:!1,lineStyle:{width:1.5,color:s.uni,type:[5,5],opacity:.5},tooltip:{show:!1}}]}},[n,a,h,g]),C={datazoom:r=>{r.batch&&r.batch[0]?v.current={start:r.batch[0].start,end:r.batch[0].end}:r.start!==void 0&&r.end!==void 0&&(v.current={start:r.start,end:r.end})}};return e.jsxs("div",{className:"page-wrapper",children:[e.jsx(oe,{title:"Parking History",shortTitle:"Hist",icon:"ðŸ“ˆ",onRefresh:p,updateStatus:x?"Updating...":"Ready",currentView:"stats",setView:u,children:e.jsxs("div",{className:"palette-group",children:[e.jsx("span",{className:"palette-label",children:"Palette:"}),Object.keys(W).map(r=>e.jsx("div",{className:`palette-btn ${a===r?"active":""}`,style:{background:`linear-gradient(135deg, ${W[r].gd} 50%, ${W[r].uni} 50%)`},onClick:()=>d(r),title:r.charAt(0).toUpperCase()+r.slice(1)},r)),e.jsxs("button",{className:"palette-toggle-btn",onClick:()=>T(!h),children:["Dots: ",h?"Off":"On"]})]})}),e.jsx("main",{className:"stats-container",children:x&&n.length===0?e.jsx("div",{className:"loader",children:"Loading history data..."}):j?e.jsx(re,{ref:f,option:j,style:{height:"100%",width:"100%",touchAction:"none"},onEvents:C,notMerge:!1,lazyUpdate:!0,opts:{renderer:"canvas"}}):e.jsx("div",{className:"loader",children:"No data available to display."})})]})};function Le(){const[u,n]=c.useState("dashboard");return e.jsx(he,{children:e.jsx(Ne,{children:u==="dashboard"?e.jsx(je,{setView:n}):e.jsx(we,{setView:n})})})}pe.createRoot(document.getElementById("root")).render(e.jsx(K.StrictMode,{children:e.jsx(Le,{})}));
